var U=Object.defineProperty;var q=(e,t,o)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var v=(e,t,o)=>q(e,typeof t!="symbol"?t+"":t,o);import{x as A,r as F,P as D,Q as B,o as O,g as j,h as Q,z as $,a3 as V,R as N,a4 as z}from"./index-BEjTALk-.js";import{a as L}from"./focus-manager-BJWzFvJg.js";import{b as H}from"./render-aB4a5-JQ.js";import{v as J}from"./vm--eZ70ppT.js";import{a as P}from"./index-B9ygI19o.js";const oe=A({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(e,{slots:t,emit:o}){const i=j(),c=F(null);let s=0;const l=[];function y(r){const d=typeof r=="boolean"?r:e.noErrorFocus!==!0,g=++s,R=(n,u)=>{o(`validation${n===!0?"Success":"Error"}`,u)},S=n=>{const u=n.validate();return typeof u.then=="function"?u.then(f=>({valid:f,comp:n}),f=>({valid:!1,comp:n,err:f})):Promise.resolve({valid:u,comp:n})};return(e.greedy===!0?Promise.all(l.map(S)).then(n=>n.filter(u=>u.valid!==!0)):l.reduce((n,u)=>n.then(()=>S(u).then(f=>{if(f.valid===!1)return Promise.reject(f)})),Promise.resolve()).catch(n=>[n])).then(n=>{if(n===void 0||n.length===0)return g===s&&R(!0),!0;if(g===s){const{comp:u,err:f}=n[0];if(f!==void 0&&console.error(f),R(!1,u),d===!0){const E=n.find(({comp:C})=>typeof C.focus=="function"&&J(C.$)===!1);E!==void 0&&E.comp.focus()}}return!1})}function T(){s++,l.forEach(r=>{typeof r.resetValidation=="function"&&r.resetValidation()})}function w(r){r!==void 0&&$(r);const d=s+1;y().then(g=>{d===s&&g===!0&&(e.onSubmit!==void 0?o("submit",r):r?.target!==void 0&&typeof r.target.submit=="function"&&r.target.submit())})}function x(r){r!==void 0&&$(r),o("reset"),V(()=>{T(),e.autofocus===!0&&e.noResetFocus!==!0&&p()})}function p(){L(()=>{if(c.value===null)return;(c.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||c.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||c.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(c.value.querySelectorAll("[tabindex]"),d=>d.tabIndex!==-1))?.focus({preventScroll:!0})})}N(z,{bindComponent(r){l.push(r)},unbindComponent(r){const d=l.indexOf(r);d!==-1&&l.splice(d,1)}});let I=!1;return D(()=>{I=!0}),B(()=>{I===!0&&e.autofocus===!0&&p()}),O(()=>{e.autofocus===!0&&p()}),Object.assign(i.proxy,{validate:y,resetValidation:T,submit:w,reset:x,focus:p,getValidationComponents:()=>l}),()=>Q("form",{class:"q-form",ref:c,onSubmit:w,onReset:x},H(t.default))}});class h extends Error{}h.prototype.name="InvalidTokenError";function K(e){return decodeURIComponent(atob(e).replace(/(.)/g,(t,o)=>{let i=o.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}function M(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return K(t)}catch{return atob(t)}}function Z(e,t){if(typeof e!="string")throw new h("Invalid token specified: must be a string");t||(t={});const o=t.header===!0?0:1,i=e.split(".")[o];if(typeof i!="string")throw new h(`Invalid token specified: missing part #${o+1}`);let c;try{c=M(i)}catch(s){throw new h(`Invalid token specified: invalid base64 for part #${o+1} (${s.message})`)}try{return JSON.parse(c)}catch(s){throw new h(`Invalid token specified: invalid json for part #${o+1} (${s.message})`)}}let k="http://212.33.245.152/";const m=P.create({withCredentials:!0,baseURL:k});m.interceptors.request.use(e=>(e.headers.Authorization=`Bearer ${localStorage.getItem("token")}`,e.port&&(e.baseURL=`${k}:${e.port}`,delete e.port),e));m.interceptors.response.use(e=>e,async e=>{const t=e.config;if(e.response.status===401&&e.config&&!e.config._isRetry){t._isRetry=!0;try{return await b.refreshToken(),m.request(t)}catch(o){console.log(o),window.em.send("NOT_AUTHORIZED")}}throw e});const a=class a{static startAutoTokenProlong(){if(a.isTokenRefreshing)return;a.refreshInterval&&clearTimeout(a.refreshInterval);let t=localStorage.getItem("token");if(!t){console.log("Nothing to prolong."),a.refreshInterval=void 0,a.isTokenRefreshing=!1;return}const i=Z(t).exp*1e3,c=Date.now(),s=i-c,l=6e4;s<=l?this.refreshToken():a.refreshInterval=setTimeout(this.refreshToken,s-l)}static async refreshToken(){a.isTokenRefreshing=!0;const t=await P.post(`${k}/api/users/refreshToken`,{},{withCredentials:!0});return this.setToken(t.data.data.accessToken),a.isTokenRefreshing=!1,t.data.data.accessToken}static setToken(t){localStorage.setItem("token",t),a.startAutoTokenProlong()}static async get(t){return await m.get(t)}static async post(t,o){return await m.post(t,o)}};v(a,"refreshInterval"),v(a,"isTokenRefreshing");let b=a;export{b as A,oe as Q};
